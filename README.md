# Workshop 6: HSV Color Picker with Flash Storage - nRF52840 Dongle

Интерактивное устройство для выбора цвета RGB-светодиода с использованием модели HSV и **сохранением настроек в энергонезависимую память**.

## Описание

Проект расширяет функционал Workshop 5, добавляя возможность сохранения выбранного цвета после перезагрузки или отключения питания. Устройство использует NVMC (Non-Volatile Memory Controller) для записи параметров HSV во Flash-память микроконтроллера.

Параметры цвета:
- **H (Hue)**: 0-360°
- **S (Saturation)**: 0-100%
- **V (Value)**: 0-100%

## Функциональность

### Запуск устройства
При включении устройства происходит проверка Flash-памяти:
1. **Если настройки были сохранены ранее**: Устройство восстанавливает последний цвет (H, S, V).
2. **Если память пуста (первый запуск)**: Цвет вычисляется на основе `DEVICE_ID` (как в Workshop 5).

> Изменить ID можно в `main.c`: `#define DEVICE_ID 1234`

### Сохранение настроек
Сохранение текущего цвета в память происходит автоматически при **выходе из режима настройки** (переход в режим "No Input").

### Режимы работы
Переключение осуществляется **двойным кликом** кнопки.

| Режим | Индикатор (LD1) | Описание | Действие при удержании |
|:---:|:---|:---|:---|
| **0** | Выключен | **No Input** | Режим ожидания. **(Сохранение данных при входе)** |
| **1** | Мигает (1 сек) | **Hue** | Изменение оттенка (0-360°) |
| **2** | Мигает (200 мс) | **Saturation** | Изменение насыщенности (0-100%) |
| **3** | Горит постоянно | **Brightness** | Изменение яркости (0-100%) |

## Аппаратная конфигурация

### Пины (PCA10059)
- **LD2 (RGB LED)**: `P0.08` (R), `P1.09` (G), `P0.12` (B).
- **LD1 (Индикатор)**: `P0.06`.
- **Кнопка (SW1)**: `P1.06` (Pull-up).

### Память
- Используется драйвер **NVMC**.
- Адрес хранения данных: `0x000F0000` (последняя страница Flash, 960 KB offset).
- Размер страницы стирания: 4 КБ.

## Принцип работы

### Работа с Flash (NVMC)
Flash-память имеет ограниченный ресурс записи и требует предварительного стирания.
1. **Упаковка**: Параметры H (16 бит), S (8 бит) и V (8 бит) упаковываются в одно 32-битное слово.
2. **Триггер сохранения**: Запись происходит только при переходе из режима *Brightness* в режим *No Input*. Это предотвращает износ памяти при активной настройке.
3. **Цикл записи**:
   - Стирание страницы по адресу `0x000F0000` (`erase`).
   - Запись упакованного значения (`write`).
   - Процессор приостанавливается на время выполнения аппаратной записи.

### Модель HSV и PWM
- **HSV**: Интуитивное управление цветом.
- **PWM**: Используется 4 канала (3 для RGB, 1 для индикатора) с разрешением 1000 шагов.
- **Button Handling**: Гибридный подход (прерывания GPIOTE для кликов + Polling для удержания).

## Сборка и прошивка

Проект требует добавления драйвера `nrfx_nvmc` в Makefile.

1. **Очистка проекта (Важно при обновлении структуры файлов):**
   ```bash
   make clean
   ```
2. **Сборка**
   ```bash
   make
   ```
3. **Прошивка (DFU): Подключите Dongle в режиме загрузчика (мигает красный светодиод) и выполните:**
   ```bash
   make dfu
   ```
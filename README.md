# Workshop 4: PWM and Double Click - nRF52840 Dongle (PCA10059)

Этот проект реализует PWM-управление светодиодами с детекцией двойного клика на nRF52840 USB Dongle (PCA10059).

## Особенности реализации

### 1. PWM-управление светодиодами
- **Последовательность LED**: RED → BLUE → GREEN (ID устройства: ABCD)
- **Частота PWM**: 1 kHz (период 1 мс)
- **Duty Cycle**: Плавный переход от 0% до 100% и обратно до 0%
- **Скорость обновления**: 20 мс между изменениями duty cycle
- **Шаг изменения**: 1% за обновление (10 единиц из 1000)
- **Время полного цикла**: ~4 секунды на один LED (2 сек вверх + 2 сек вниз)

### 2. Обработка кнопки через GPIOTE
- Использует модуль GPIOTE (GPIO Tasks and Events) для эффективной обработки
- Прерывания на изменение состояния кнопки
- Программный debounce: 50 мс
- Легковесный обработчик прерываний (следуя рекомендациям из лекций)

### 3. Детекция двойного клика
- **Окно двойного клика**: 400 мс между нажатиями
- **Поведение при запуске**: Двойной клик → запуск плавного мигания с начала
- **Поведение при остановке**: Двойной клик во время мигания → заморозка текущего LED на текущей яркости
- **Возобновление**: Ещё один двойной клик → перезапуск с начала последовательности

### 4. Таймер
- Простой программный счётчик с инкрементом каждую 1 мс
- Использует `nrf_delay_ms()` для точности
- Никаких сложных зависимостей от app_timer или RTC

## Конфигурация оборудования

### Назначение пинов для PCA10059

**RGB LED (LD2)** - используется для последовательности:

| Переменная | Пин | Цвет | Роль |
|------------|-----|------|------|
| `LED_RED` | P0.08 | Красный | Первый в последовательности |
| `LED_BLUE` | P0.12 | Синий | Второй в последовательности |
| `LED_GREEN` | P1.09 | Зелёный | Третий в последовательности |

**Кнопка:**

| Переменная | Пин | Функция |
|------------|-----|---------|
| `BUTTON_PIN` | P1.06 | SW1 с подтяжкой к питанию |

**Важно:** LED на PCA10059 подключены **активным высоким уровнем** (не через общий анод):
- 0 на PWM выходе = LED выключен
- 1000 на PWM выходе = LED на полной яркости

## Принцип работы

### Схема состояний

```
[ВЫКЛЮЧЕНО - все LED погашены]
           ↓
    (двойной клик)
           ↓
[МИГАЕТ: RED плавно 0%→100%→0%]
           ↓ (автоматически)
[МИГАЕТ: BLUE плавно 0%→100%→0%]
           ↓ (автоматически)
[МИГАЕТ: GREEN плавно 0%→100%→0%]
           ↓ (цикл повторяется)
    [обратно к RED...]
           |
    (двойной клик во время мигания)
           ↓
[ЗАМОРОЖЕНО: текущий LED светит на текущей яркости]
           ↓
    (двойной клик)
           ↓
[МИГАЕТ: RED с начала (0%→100%...)]
```

### Поведение системы

**1. Начальное состояние (после включения/сброса):**
- Все три LED кратко загораются белым светом (100 мс) - индикация инициализации
- Затем все LED гаснут
- Система ждёт двойного клика

**2. Одиночный клик:**
- Ничего не происходит
- Система ждёт второй клик в течение 400 мс

**3. Двойной клик (два нажатия < 400 мс):**

**Если система выключена:**
- Запускается последовательность плавного мигания
- Красный LED начинает плавно загораться от 0% до 100%
- Затем плавно гаснет от 100% до 0%
- Автоматически переключается на синий, затем зелёный
- Цикл повторяется бесконечно

**Если система мигает:**
- Мигание останавливается ("замораживается")
- Текущий LED остаётся светить с текущей яркостью
- Например: если красный был на 60% яркости → останется на 60%

**Если система заморожена:**
- Мигание возобновляется с начала
- Всегда начинается с красного LED
- Duty cycle стартует с 0%

## Технические детали

### PWM конфигурация
```c
Базовая частота: 1 MHz
Top value:       1000
Результат:       1 MHz / 1000 = 1 kHz PWM

Режим счёта:     UP (нарастающий)
Режим загрузки:  INDIVIDUAL (индивидуальный для каждого канала)
Режим шага:      AUTO (автоматический)
```

### Временные параметры
```c
PWM_UPDATE_INTERVAL_MS = 20    // Обновление каждые 20 мс
PWM_STEP = 10                  // Изменение на 1% за обновление
DOUBLE_CLICK_TIMEOUT_MS = 400  // Окно для двойного клика
DEBOUNCE_MS = 50               // Антидребезг кнопки
```

### Расчёт времени переходов
```
Полный переход 0% → 100%:
  100 шагов × 20 мс = 2000 мс = 2 секунды

Полный цикл одного LED (загорание + гашение):
  2 сек + 2 сек = 4 секунды

Полная последовательность трёх LED:
  4 сек × 3 = 12 секунд
```

## Сборка и прошивка

### Предварительные требования
- nRF5 SDK установлен в `/home/user/devel/esl-nsdk`
- ARM GCC toolchain
- nrfutil для DFU прошивки

### Команды сборки

```bash
# Сборка проекта
make clean
make SDK_ROOT=/home/user/devel/esl-nsdk

# Прошивка через DFU (USB)
make dfu SDK_ROOT=/home/user/devel/esl-nsdk DFU_PORT=/dev/ttyACM0

# Если порт другой, найдите его:
ls /dev/ttyACM*
```

### Выходные файлы
```
_build/nrf52840_xxaa.hex    - Intel HEX файл
_build/nrf52840_xxaa.bin    - Бинарный файл
_build/nrf52840_xxaa.out    - ELF файл с символами
_build/nrf52840_xxaa.map    - Map файл
```

## Структура кода

### Основные компоненты

**1. Инициализация (`main()`)**
- Инициализирует PWM модуль
- Настраивает GPIOTE для кнопки
- Показывает белую вспышку (индикация готовности)
- Запускает главный цикл

**2. PWM управление (`pwm_init()`, `update_pwm_output()`)**
- Настраивает три канала PWM для RGB LED
- Устанавливает частоту 1 kHz
- Обновляет значения duty cycle для текущего LED

**3. Обработка duty cycle (`update_duty_cycle()`)**
- Вызывается каждую 1 мс из главного цикла
- Проверяет, прошло ли 20 мс с последнего обновления
- Изменяет duty cycle на 1% (вверх или вниз)
- Переключает на следующий LED при достижении 0%

**4. GPIOTE обработчик (`gpiote_event_handler()`)**
- Вызывается при нажатии кнопки (прерывание)
- Реализует debounce (50 мс)
- Отслеживает время между кликами
- Детектирует двойной клик (< 400 мс)

**5. Главный цикл**
- Обновляет duty cycle если мигание активно
- Проверяет timeout для двойного клика
- Задержка 1 мс и инкремент счётчика времени

## Тестирование

### Базовый сценарий

**Шаг 1: Проверка инициализации**
1. Прошейте устройство
2. После перезагрузки должна появиться **белая вспышка (100 мс)**
3. Все LED должны **погаснуть**

**Шаг 2: Запуск мигания**
1. Быстро нажмите кнопку SW1 **два раза** (интервал < 400 мс)
2. **Ожидается:** Красный LED начнёт **плавно загораться**
3. Дождитесь полного цикла: загорание → гашение
4. **Ожидается:** Синий LED начнёт мигать
5. После синего → зелёный
6. После зелёного → снова красный (цикл)

**Шаг 3: Заморозка**
1. Пока мигает любой LED (например, на ~50% яркости)
2. Снова нажмите кнопку **два раза быстро**
3. **Ожидается:** LED **остановится** на текущей яркости
4. Мигание прекращается

**Шаг 4: Возобновление**
1. В замороженном состоянии снова **двойной клик**
2. **Ожидается:** Красный LED начнёт мигать **с начала** (с 0%)
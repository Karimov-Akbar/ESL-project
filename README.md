# Workshop 7: HSV Color Picker with USB CLI - nRF52840 Dongle

Интерактивное устройство для выбора цвета RGB-светодиода с поддержкой **USB CLI (Command Line Interface)** и сохранением настроек в энергонезависимую память.

## Описание

Проект объединяет управление через кнопку (из Workshop 6) и управление через текстовую консоль USB (Workshop 7). Устройство подключается к компьютеру как виртуальный COM-порт (CDC ACM), позволяя задавать цвет командами `RGB` и `HSV`.

Параметры цвета:
- **H (Hue)**: 0-360°
- **S (Saturation)**: 0-100%
- **V (Value)**: 0-100%

## Функциональность

### 1. USB Интерфейс (CLI)
При подключении к компьютеру устройство определяется как `USB_CLI`. Доступна консоль с поддержкой эха (отображение вводимых символов).

**Поддерживаемые команды:**

| Команда | Аргументы | Описание | Пример |
|:---|:---|:---|:---|
| **`RGB`** | `<r> <g> <b>` | Установить цвет в формате RGB (0-1000) | `RGB 1000 0 0` (Красный) |
| **`HSV`** | `<h> <s> <v>` | Установить цвет в формате HSV | `HSV 120 100 100` (Зеленый) |
| **`help`** | - | Вывести список команд | `help` |

*   При вводе некорректной команды выводится: `Unknown command`.
*   При вводе некорректных аргументов выводится сообщение об ошибке.

### 2. Кнопочное управление (Режимы)
Переключение режимов осуществляется **двойным кликом** кнопки.

| Режим | Индикатор (LD1) | Описание | Действие при удержании |
|:---:|:---|:---|:---|
| **0** | Выключен | **No Input** | Режим ожидания. **(Сохранение во Flash при входе)** |
| **1** | Мигает (1 сек) | **Hue** | Изменение оттенка (0-360°) |
| **2** | Мигает (200 мс) | **Saturation** | Изменение насыщенности (0-100%) |
| **3** | Горит постоянно | **Brightness** | Изменение яркости (0-100%) |

### 3. Память и Запуск
- **Сохранение**: Текущий цвет сохраняется во Flash-память при выходе из режима настройки кнопкой или (опционально) при смене цвета.
- **Восстановление**: При включении устройство восстанавливает последний цвет. Если память пуста — вычисляется цвет на основе `DEVICE_ID`.

## Аппаратная конфигурация

### Пины (PCA10059)
- **LD2 (RGB LED)**: `P0.08` (R), `P1.09` (G), `P0.12` (B).
- **LD1 (Индикатор)**: `P0.06`.
- **Кнопка (SW1)**: `P1.06` (Pull-up).
- **USB**: Стандартные линии D+/D- (используется драйвер USBD).

## Принцип работы

### USB Stack (CDC ACM)
Используется библиотека Nordic `app_usbd` с классом CDC ACM.
- Устройство эмулирует последовательный порт (`/dev/ttyACM0` в Linux).
- Реализован строчный буфер: символы накапливаются до нажатия `Enter`.
- Реализована функция `rgb_to_hsv`, чтобы команды RGB корректно обновляли внутреннее состояние HSV.

### Работа с Flash (NVMC)
- Адрес хранения: `0x000F0000`.
- Используется прямой доступ к NVMC для стирания страниц и записи слов.

### Модель HSV
- Все вычисления производятся в целочисленной арифметике для быстродействия.
- Преобразование `HSV -> RGB` для управления светодиодами.
- Преобразование `RGB -> HSV` для обработки команд консоли.

## Сборка и прошивка

**Требования:** Nordic SDK 15.x/16.x, `arm-none-eabi-gcc`, `nrfutil`, `make`.

1. **Очистка проекта:**
   ```bash
   make clean
   ```
2. **Сборка**
   ```bash
   make
   ```
3. **Прошивка (DFU): Подключите Dongle в режиме загрузчика (мигает красный светодиод) и выполните:**
   ```bash
   make dfu
   ```

## Тестирование

### Проверка CLI (Linux)
Для подключения рекомендуется использовать `picocom` (проще) или `minicom`.

1. Установите терминал:
   ```bash
   sudo apt install picocom
   ```
2. Подключитесь к устройству (важно отключить управление потоком `--flow n`):
   ```bash
   sudo picocom /dev/ttyACM0 -b 115200 --flow n
   ```
3. Нажмите `Enter`. Должно появиться приглашение `>`.
4. Вводите команды:
   - `help`
   - `RGB 0 0 1000` (Включить синий)
   - `HSV 0 100 100` (Включить красный)

*Выход из picocom: `Ctrl+A`, затем `Ctrl+X`.*

### Проверка сохранения
1. Установите цвет через консоль или кнопку.
2. Перезагрузите устройство (выньте и вставьте в USB).
3. Устройство должно включиться с последним установленным цветом.
